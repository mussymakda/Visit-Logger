<x-filament-panels::page>
    <div class="space-y-6">
        
        <!-- Simple QR Scanner Section -->
        <x-filament::section>
            <x-slot name="heading">QR Code Scanner</x-slot>
            <x-slot name="description">Scan sponsor QR codes to log your visits</x-slot>
            
            <div class="text-center space-y-4">
                <div class="flex justify-center">
                    <div id="qr-reader" style="width: 300px; height: 300px; border: 2px solid #e5e7eb; border-radius: 8px;"></div>
                </div>
                
                <div class="space-x-3">
                    <x-filament::button id="start-scanner" color="primary">
                        Start Scanner
                    </x-filament::button>
                    <x-filament::button id="stop-scanner" color="danger" style="display: none;">
                        Stop Scanner
                    </x-filament::button>
                </div>
                
                <div>
                    <x-filament::button id="test-sponsor-3" color="warning" size="sm">
                        Test Sponsor #3
                    </x-filament::button>
                    <p class="text-xs text-gray-500 mt-2">For testing: sponsor IDs 1-8</p>
                </div>
            </div>
        </x-filament::section>

        <!-- Status Messages -->
        <div id="status-container"></div>

        <!-- Sponsor Information -->
        <div id="sponsor-section" style="display: none;">
            <x-filament::section>
                <x-slot name="heading">Sponsor Information</x-slot>
                <div id="sponsor-details"></div>
                <div class="mt-4 space-x-3 text-center">
                    <x-filament::button id="take-photo" color="primary">Take Photo</x-filament::button>
                    <x-filament::button id="rescan-qr" color="gray">Scan Again</x-filament::button>
                </div>
            </x-filament::section>
        </div>

        <!-- Photo Section -->
        <div id="photo-section" style="display: none;">
            <x-filament::section>
                <x-slot name="heading">Take Site Photo</x-slot>
                <div class="text-center space-y-4">
                    <input type="file" id="site-photo" accept="image/*" capture="environment" style="display: none;">
                    <x-filament::button onclick="document.getElementById('site-photo').click()" color="primary">
                        Choose Photo
                    </x-filament::button>
                    
                    <div id="photo-preview" style="display: none;">
                        <img id="preview-image" src="" alt="Preview" style="max-width: 300px; max-height: 200px; margin: 0 auto; border-radius: 8px;">
                        <div class="mt-3 space-x-3">
                            <x-filament::button id="confirm-photo" color="success">Use Photo</x-filament::button>
                            <x-filament::button id="retake-photo" color="gray">Try Again</x-filament::button>
                        </div>
                    </div>
                </div>
            </x-filament::section>
        </div>

        <!-- Submit Section -->
        <div id="submit-section" style="display: none;">
            <x-filament::section>
                <x-slot name="heading">Submit Visit</x-slot>
                <div id="visit-summary" class="mb-4 p-3 bg-gray-50 rounded"></div>
                <div class="text-center space-x-3">
                    <x-filament::button id="confirm-submit" color="success">Submit Visit</x-filament::button>
                    <x-filament::button id="start-over" color="gray">Start Over</x-filament::button>
                </div>
                <div id="submit-progress" style="display: none;" class="text-center mt-4">
                    <x-filament::loading-indicator />
                    <p class="text-sm text-gray-600 mt-2">Submitting...</p>
                </div>
            </x-filament::section>
        </div>

        <!-- Success Section -->
        <div id="success-section" style="display: none;">
            <x-filament::section>
                <div class="text-center space-y-4">
                    <div class="text-green-600 text-4xl">âœ“</div>
                    <h3 class="text-lg font-medium">Visit Logged Successfully!</h3>
                    <x-filament::button id="log-another-visit" color="success">Log Another Visit</x-filament::button>
                </div>
            </x-filament::section>
        </div>
    </div>

    @push('scripts')
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <script>
    let html5QrcodeScanner;
    let currentSponsor = null;
    let capturedPhoto = null;

    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById('start-scanner').addEventListener('click', startQRScanner);
        document.getElementById('stop-scanner').addEventListener('click', stopQRScanner);
        document.getElementById('test-sponsor-3').addEventListener('click', () => fetchSponsorData(3));
        document.getElementById('take-photo').addEventListener('click', showPhotoSection);
        document.getElementById('rescan-qr').addEventListener('click', restartScanning);
        document.getElementById('site-photo').addEventListener('change', handlePhotoSelection);
        document.getElementById('confirm-photo').addEventListener('click', showSubmitSection);
        document.getElementById('retake-photo').addEventListener('click', retakePhoto);
        document.getElementById('confirm-submit').addEventListener('click', submitVisit);
        document.getElementById('start-over').addEventListener('click', startOver);
        document.getElementById('log-another-visit').addEventListener('click', startOver);
    }

    function startQRScanner() {
        html5QrcodeScanner = new Html5Qrcode("qr-reader");
        
        html5QrcodeScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            () => {} // Ignore scan errors
        ).then(() => {
            document.getElementById('start-scanner').style.display = 'none';
            document.getElementById('stop-scanner').style.display = 'inline-block';
        }).catch(() => {
            showStatus('error', 'Failed to start camera');
        });
    }

    function stopQRScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                document.getElementById('start-scanner').style.display = 'inline-block';
                document.getElementById('stop-scanner').style.display = 'none';
            });
        }
    }

    function onScanSuccess(decodedText) {
        const sponsorId = parseSponsorId(decodedText);
        if (sponsorId) {
            stopQRScanner();
            fetchSponsorData(sponsorId);
        }
    }

    function parseSponsorId(qrText) {
        if (/^\d+$/.test(qrText)) return parseInt(qrText);
        const match = qrText.match(/sponsor[=_-](\d+)/i);
        return match ? parseInt(match[1]) : null;
    }

    function fetchSponsorData(sponsorId) {
        showStatus('info', 'Looking up sponsor...');
        
        fetch(`/api/sponsors/${sponsorId}`, {
            headers: {
                'Accept': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                currentSponsor = data;
                displaySponsorInfo(data);
                showSponsorSection();
                showStatus('success', 'Sponsor verified!');
            } else {
                showStatus('error', 'Sponsor not found');
            }
        })
        .catch(() => showStatus('error', 'Error fetching sponsor'));
    }

    function displaySponsorInfo(sponsor) {
        document.getElementById('sponsor-details').innerHTML = `
            <div class="space-y-3">
                <div class="bg-blue-50 p-3 rounded">
                    <h4 class="font-medium">${sponsor.name}</h4>
                    <p class="text-sm text-gray-600">${sponsor.company_name}</p>
                </div>
                <div class="text-sm space-y-1">
                    <div><strong>Contact:</strong> ${sponsor.contact || 'N/A'}</div>
                    <div><strong>Location:</strong> ${sponsor.location || 'N/A'}</div>
                </div>
            </div>
        `;
    }

    function showSponsorSection() {
        hideAllSections();
        document.getElementById('sponsor-section').style.display = 'block';
    }

    function showPhotoSection() {
        hideAllSections();
        document.getElementById('photo-section').style.display = 'block';
    }

    function showSubmitSection() {
        if (!capturedPhoto) {
            showStatus('error', 'Please select a photo');
            return;
        }
        hideAllSections();
        document.getElementById('submit-section').style.display = 'block';
        displayVisitSummary();
    }

    function handlePhotoSelection(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('preview-image').src = e.target.result;
                document.getElementById('photo-preview').style.display = 'block';
                capturedPhoto = file;
            };
            reader.readAsDataURL(file);
        }
    }

    function retakePhoto() {
        document.getElementById('site-photo').value = '';
        document.getElementById('photo-preview').style.display = 'none';
        capturedPhoto = null;
    }

    function displayVisitSummary() {
        document.getElementById('visit-summary').innerHTML = `
            <h4 class="font-medium mb-2">Visit Summary</h4>
            <div class="text-sm space-y-1">
                <div><strong>Sponsor:</strong> ${currentSponsor.name}</div>
                <div><strong>Company:</strong> ${currentSponsor.company_name}</div>
                <div><strong>Time:</strong> ${new Date().toLocaleString()}</div>
                <div><strong>Photo:</strong> âœ“ Ready</div>
            </div>
        `;
    }

    function submitVisit() {
        document.getElementById('submit-progress').style.display = 'block';
        
        const formData = new FormData();
        formData.append('sponsor_id', currentSponsor.id);
        formData.append('site_photo', capturedPhoto);
        formData.append('visited_at', new Date().toISOString());
        
        fetch('/api/visits', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('submit-progress').style.display = 'none';
            if (data.success) {
                hideAllSections();
                document.getElementById('success-section').style.display = 'block';
                hideStatus();
            } else {
                showStatus('error', 'Submit failed');
            }
        })
        .catch(() => {
            document.getElementById('submit-progress').style.display = 'none';
            showStatus('error', 'Submit error');
        });
    }

    function restartScanning() {
        currentSponsor = null;
        hideAllSections();
        document.getElementById('qr-reader').innerHTML = '';
        document.getElementById('start-scanner').style.display = 'inline-block';
        document.getElementById('stop-scanner').style.display = 'none';
    }

    function startOver() {
        currentSponsor = null;
        capturedPhoto = null;
        document.getElementById('site-photo').value = '';
        document.getElementById('photo-preview').style.display = 'none';
        hideAllSections();
        hideStatus();
        document.getElementById('qr-reader').innerHTML = '';
        document.getElementById('start-scanner').style.display = 'inline-block';
        document.getElementById('stop-scanner').style.display = 'none';
    }

    function hideAllSections() {
        ['sponsor-section', 'photo-section', 'submit-section', 'success-section'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
    }

    function showStatus(type, message) {
        const colors = {
            success: 'text-green-800 bg-green-50 border-green-200',
            error: 'text-red-800 bg-red-50 border-red-200',
            info: 'text-blue-800 bg-blue-50 border-blue-200'
        };
        
        document.getElementById('status-container').innerHTML = `
            <div class="p-3 rounded border text-center ${colors[type]}">${message}</div>
        `;
        
        if (type === 'success' || type === 'info') {
            setTimeout(hideStatus, 3000);
        }
    }

    function hideStatus() {
        document.getElementById('status-container').innerHTML = '';
    }
    </script>
    @endpush
</x-filament-panels::page>

        <!-- Sponsor Information (Initially Hidden) -->
        <div id="sponsor-info" class="hidden bg-white rounded-lg shadow border">
            <div class="border-b bg-green-50 p-3 flex justify-between items-center">
                <h2 class="font-medium text-gray-800">Sponsor Found</h2>
                <span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">âœ“ Verified</span>
            </div>
            <div class="p-4">
                <div id="sponsor-details" class="space-y-3">
                    <!-- Sponsor details will be populated here -->
                </div>
                <div class="mt-4 flex justify-center space-x-2">
                    <button id="take-photo" class="px-3 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                        Take Photo
                    </button>
                    <button id="rescan-qr" class="px-3 py-2 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">
                        Scan Again
                    </button>
                </div>
            </div>
        </div>

        <!-- Photo Capture (Initially Hidden) -->
        <div id="photo-capture" class="hidden bg-white rounded-lg shadow border">
            <div class="border-b p-3">
                <h2 class="font-medium text-gray-800">Take Photo</h2>
            </div>
            <div class="p-4 space-y-3">
                <div class="text-center">
                    <label for="site-photo" class="cursor-pointer inline-block px-4 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                        Choose Photo
                        <input type="file" id="site-photo" accept="image/*" capture="environment" class="hidden">
                    </label>
                </div>
                
                <div id="photo-preview" class="hidden text-center">
                    <img id="preview-image" src="" alt="Photo preview" class="max-w-full max-h-40 rounded border mx-auto mb-3">
                    <div class="space-x-2">
                        <button id="confirm-photo" class="px-3 py-2 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                            Use Photo
                        </button>
                        <button id="retake-photo" class="px-3 py-2 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">
                            Choose Again
                        </button>
                    </div>
                </div>
                
                <p class="text-center text-xs text-gray-500">
                    Take a photo of the sponsor location
                </p>
            </div>
        </div>

        <!-- Submit Visit (Initially Hidden) -->
        <div id="submit-visit" class="hidden bg-white rounded-lg shadow border">
            <div class="border-b p-3">
                <h2 class="font-medium text-gray-800">Submit Visit</h2>
            </div>
            <div class="p-4">
                <div class="bg-gray-50 rounded p-3 mb-4">
                    <h3 class="font-medium text-gray-700 text-sm mb-2">Visit Summary</h3>
                    <div id="visit-summary" class="text-xs text-gray-600">
                        <!-- Visit summary will be populated here -->
                    </div>
                </div>
                
                <div class="flex justify-center space-x-2">
                    <button id="confirm-submit" class="px-4 py-2 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                        Submit Visit
                    </button>
                    <button id="start-over" class="px-4 py-2 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">
                        Start Over
                    </button>
                </div>
                
                <div id="submit-progress" class="hidden mt-3 text-center">
                    <div class="animate-spin w-5 h-5 border-2 border-green-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                    <p class="text-xs text-gray-600">Submitting...</p>
                </div>
            </div>
        </div>

        <!-- Success Message (Initially Hidden) -->
        <div id="success-message" class="hidden bg-green-50 border border-green-100 rounded-lg">
            <div class="p-4 text-center">
                <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center mx-auto mb-3">
                    âœ“
                </div>
                <h2 class="font-semibold text-green-800 mb-2">Success!</h2>
                <p class="text-green-600 text-sm mb-4">Visit logged successfully</p>
                <button id="log-another-visit" class="px-4 py-2 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                    Log Another Visit
                </button>
            </div>
        </div>
    </div>

    @push('scripts')
    <!-- Include QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <script>
    let html5QrcodeScanner;
    let currentSponsor = null;
    let capturedPhoto = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, initializing QR scanner...');
        initializeQRScanner();
        setupEventListeners();
    });

    function initializeQRScanner() {
        console.log('Setting up QR scanner...');
        
        // Auto-start the scanner
        setTimeout(() => {
            startQRScanner();
        }, 1000);
    }

    function setupEventListeners() {
        // QR Scanner buttons
        document.getElementById('start-scanner').addEventListener('click', startQRScanner);
        document.getElementById('stop-scanner').addEventListener('click', stopQRScanner);
        
        // Test button
        document.getElementById('test-sponsor-3').addEventListener('click', function() {
            console.log('Test button clicked - fetching sponsor 3');
            fetchSponsorData(3);
        });
        
        // Sponsor verification
        document.getElementById('take-photo').addEventListener('click', showPhotoCapture);
        document.getElementById('rescan-qr').addEventListener('click', restartScanning);
        
        // Photo capture
        document.getElementById('site-photo').addEventListener('change', handlePhotoSelection);
        document.getElementById('confirm-photo').addEventListener('click', showSubmitVisit);
        document.getElementById('retake-photo').addEventListener('click', retakePhoto);
        
        // Visit submission
        document.getElementById('confirm-submit').addEventListener('click', submitVisit);
        document.getElementById('start-over').addEventListener('click', startOver);
        document.getElementById('log-another-visit').addEventListener('click', startOver);
    }

    function startQRScanner() {
        console.log('Starting QR scanner...');
        
        html5QrcodeScanner = new Html5Qrcode("qr-reader");
        
        const config = {
            fps: 10,
            qrbox: { width: 220, height: 220 },
            aspectRatio: 1.0
        };

        html5QrcodeScanner.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanError
        ).then(() => {
            console.log('QR scanner started successfully');
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('start-scanner').classList.add('hidden');
            document.getElementById('stop-scanner').classList.remove('hidden');
        }).catch((error) => {
            console.error('Failed to start QR scanner:', error);
            document.getElementById('loading-overlay').style.display = 'none';
            showStatus('error', 'Failed to start camera. Please check permissions.');
        });
    }

    function stopQRScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                console.log('QR scanner stopped');
                document.getElementById('start-scanner').classList.remove('hidden');
                document.getElementById('stop-scanner').classList.add('hidden');
                document.getElementById('loading-overlay').style.display = 'flex';
            }).catch((error) => {
                console.error('Error stopping scanner:', error);
            });
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log('QR Code detected:', decodedText);
        
        // Parse sponsor ID from QR code
        const sponsorId = parseSponsorId(decodedText);
        
        if (sponsorId) {
            console.log('Parsed sponsor ID:', sponsorId);
            stopQRScanner();
            fetchSponsorData(sponsorId);
        } else {
            console.warn('Could not parse sponsor ID from QR code:', decodedText);
            showStatus('error', 'Invalid QR code format. Please scan a valid sponsor QR code.');
        }
    }

    function onScanError(error) {
        // Suppress frequent scan errors
        if (error.includes('NotFoundException')) {
            return;
        }
        console.log('QR Scan error:', error);
    }

    function parseSponsorId(qrText) {
        console.log('Parsing QR text:', qrText);
        
        // Try to extract the ID directly - prioritize plain number format
        
        // First check if it's just a plain number
        if (/^\d+$/.test(qrText)) {
            const id = parseInt(qrText);
            console.log('Found plain sponsor ID:', id);
            return id;
        }
        
        // Then try other common formats
        const patterns = [
            /sponsor[=_-](\d+)/i,  // sponsor=123, sponsor_123, sponsor-123
            /SPONSOR[=_-](\d+)/,   // SPONSOR=123, SPONSOR_123, SPONSOR-123
            /(\d+)$/,              // Just a number at the end
        ];
        
        for (const pattern of patterns) {
            const match = qrText.match(pattern);
            if (match) {
                const id = parseInt(match[1]);
                console.log('Found sponsor ID:', id);
                return id;
            }
        }
        
        // For testing purposes, allow hardcoded IDs 1-8
        if (qrText.toLowerCase() === 'test') {
            console.log('Test mode - using sponsor ID 1');
            return 1;
        }
        
        console.warn('Could not parse sponsor ID from:', qrText);
        return null;
    }

    function fetchSponsorData(sponsorId) {
        console.log('Fetching sponsor data for ID:', sponsorId);
        showStatus('info', 'Looking up sponsor information...');
        
        fetch(`/api/sponsors/${sponsorId}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            credentials: 'same-origin'
        })
        .then(response => {
            console.log('API Response status:', response.status);
            console.log('API Response ok:', response.ok);
            
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Sponsor data received:', data);
            if (data.id) {
                currentSponsor = data;
                displaySponsorInfo(data);
                showSponsorInfo();
                showStatus('success', 'Sponsor verified successfully!');
            } else {
                console.error('Invalid sponsor data format:', data);
                showStatus('error', 'Invalid sponsor data received.');
            }
        })
        .catch(error => {
            console.error('Error fetching sponsor:', error);
            showStatus('error', `Error: ${error.message}. Check browser console for details.`);
        });
    }

    function displaySponsorInfo(sponsor) {
        const detailsContainer = document.getElementById('sponsor-details');
        detailsContainer.innerHTML = `
            <div class="bg-blue-50 p-3 rounded">
                <h3 class="font-medium text-blue-800">${sponsor.name || 'N/A'}</h3>
                <p class="text-blue-600 text-sm">${sponsor.company_name || 'N/A'}</p>
            </div>
            <div class="text-sm space-y-1">
                <div><strong>Contact:</strong> ${sponsor.contact || 'N/A'}</div>
                <div><strong>Location:</strong> ${sponsor.location || 'N/A'}</div>
                <div><strong>Description:</strong> ${sponsor.description || 'N/A'}</div>
            </div>
        `;
    }

    function showSponsorInfo() {
        hideAllSections();
        document.getElementById('sponsor-info').classList.remove('hidden');
    }

    function showPhotoCapture() {
        hideAllSections();
        document.getElementById('photo-capture').classList.remove('hidden');
    }

    function showSubmitVisit() {
        if (!capturedPhoto) {
            showStatus('error', 'Please take a photo first.');
            return;
        }
        
        hideAllSections();
        document.getElementById('submit-visit').classList.remove('hidden');
        displayVisitSummary();
    }

    function handlePhotoSelection(event) {
        const file = event.target.files[0];
        if (file) {
            console.log('Photo selected:', file.name, file.size);
            
            if (file.size > 10 * 1024 * 1024) {
                showStatus('error', 'Photo is too large. Please select a file under 10MB.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-image').src = e.target.result;
                document.getElementById('photo-preview').classList.remove('hidden');
                capturedPhoto = file;
            };
            reader.readAsDataURL(file);
        }
    }

    function retakePhoto() {
        document.getElementById('site-photo').value = '';
        document.getElementById('photo-preview').classList.add('hidden');
        capturedPhoto = null;
    }

    function displayVisitSummary() {
        const summaryContainer = document.getElementById('visit-summary');
        const visitTime = new Date().toLocaleString();
        
        summaryContainer.innerHTML = `
            <div class="space-y-1">
                <div><strong>Sponsor:</strong> ${currentSponsor.name}</div>
                <div><strong>Company:</strong> ${currentSponsor.company_name}</div>
                <div><strong>Location:</strong> ${currentSponsor.location}</div>
                <div><strong>Time:</strong> ${visitTime}</div>
                <div><strong>Photo:</strong> âœ“ Captured</div>
                <div><strong>Designer:</strong> {{ auth()->user()->name }}</div>
            </div>
        `;
    }

    function submitVisit() {
        if (!currentSponsor || !capturedPhoto) {
            showStatus('error', 'Missing required information.');
            return;
        }
        
        console.log('Submitting visit...');
        document.getElementById('submit-progress').classList.remove('hidden');
        
        const formData = new FormData();
        formData.append('sponsor_id', currentSponsor.id);
        formData.append('site_photo', capturedPhoto);
        formData.append('visited_at', new Date().toISOString());
        
        fetch('/api/visits', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                'Accept': 'application/json'
            }
        })
        .then(response => {
            console.log('Submit response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Submit response:', data);
            document.getElementById('submit-progress').classList.add('hidden');
            
            if (data.success) {
                showSuccessMessage();
            } else {
                showStatus('error', data.message || 'Failed to submit visit.');
            }
        })
        .catch(error => {
            console.error('Submit error:', error);
            document.getElementById('submit-progress').classList.add('hidden');
            showStatus('error', 'Error submitting visit: ' + error.message);
        });
    }

    function showSuccessMessage() {
        hideAllSections();
        document.getElementById('success-message').classList.remove('hidden');
        hideStatus();
    }

    function startOver() {
        currentSponsor = null;
        capturedPhoto = null;
        
        // Reset photo input
        document.getElementById('site-photo').value = '';
        document.getElementById('photo-preview').classList.add('hidden');
        
        // Clear status
        hideStatus();
        
        // Show scanner section
        hideAllSections();
        document.getElementById('qr-reader').innerHTML = '';
        document.getElementById('loading-overlay').style.display = 'flex';
        document.getElementById('start-scanner').classList.remove('hidden');
        document.getElementById('stop-scanner').classList.add('hidden');
        
        // Restart scanner after a short delay
        setTimeout(() => {
            startQRScanner();
        }, 500);
    }

    function restartScanning() {
        currentSponsor = null;
        hideAllSections();
        document.getElementById('qr-reader').innerHTML = '';
        document.getElementById('loading-overlay').style.display = 'flex';
        setTimeout(() => {
            startQRScanner();
        }, 500);
    }

    function hideAllSections() {
        // Hide all main sections
        const sections = [
            'sponsor-info',
            'photo-capture',
            'submit-visit',
            'success-message'
        ];
        
        sections.forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
    }

    function showStatus(type, message) {
        const statusMessage = document.getElementById('status-message');
        
        // Reset classes
        statusMessage.className = 'rounded-lg p-4 text-center shadow-md';
        
        // Add appropriate styling based on message type
        switch (type) {
            case 'success':
                statusMessage.classList.add('bg-green-50', 'text-green-800', 'border', 'border-green-200');
                break;
            case 'error':
                statusMessage.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
                break;
            case 'info':
                statusMessage.classList.add('bg-blue-50', 'text-blue-800', 'border', 'border-blue-200');
                break;
        }
        
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden');
        
        // Auto-hide success and info messages
        if (type === 'success' || type === 'info') {
            setTimeout(hideStatus, 3000);
        }
    }

    function hideStatus() {
        document.getElementById('status-message').classList.add('hidden');
    }
    </script>
    
    <!-- CSRF Token Meta -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    @endpush
</x-filament-panels::page>